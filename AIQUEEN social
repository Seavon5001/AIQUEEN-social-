import React, { useState, useEffect, useCallback } from 'react';
import { Send, Crown, DollarSign, Phone, Mail, Share2, Loader, Zap, AlertTriangle } from 'lucide-react';

const AIQUEEN_NAME = "AIQUEEN Superior 1.1";
const AI_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
const DEFAULT_SYSTEM_PROMPT = "You are AIQUEEN Superior 1.1, a smart, fast, and highly capable AI agent for global campaign management and multitasking. Respond precisely to the user's command.";

/**
 * Utility function to append a message to the chat history.
 */
const appendMessage = (role, text, history, setHistory) => {
    setHistory(prev => [...prev, { role, text }]);
};

/**
 * Custom Modal/Message Box component.
 */
const MessageBox = ({ message, type, onClose }) => {
    if (!message) return null;

    const isError = type === 'error';
    const headerClasses = isError 
        ? 'bg-red-100 border-red-400 text-red-700' 
        : 'bg-green-100 border-green-400 text-green-700';
    const titleText = isError ? 'Error' : 'Success';

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm">
                <div className={`border px-4 py-3 rounded-t-xl ${headerClasses}`}>
                    <p className="font-bold text-lg">{titleText}</p>
                </div>
                <div className="p-4">
                    <p className="text-gray-700">{message}</p>
                </div>
                <div className="p-4 border-t flex justify-end">
                    <button
                        onClick={onClose}
                        className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    );
};

/**
 * Core function to call the Gemini API directly from the client (INSECURE for production).
 */
async function callGeminiApi(prompt, apiKey) {
    if (!apiKey) {
        throw new Error("GEMINI_API_KEY is missing. Please enter your key in the field provided.");
    }

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=${apiKey}`;
    const maxRetries = 3;

    // Payload structure for the Gemini API call
    const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        config: {
            systemInstruction: { parts: [{ text: DEFAULT_SYSTEM_PROMPT }] },
            tools: [{ googleSearch: {} }],
        },
    };

    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok) {
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    return { ok: true, text: text };
                } else {
                    return { ok: false, error: 'AI returned an empty or malformed response.' };
                }
            } else {
                // If API returns an error status (e.g., 400, 401)
                const errorMessage = result.error?.message || `API error (${response.status}): ${JSON.stringify(result)}`;
                throw new Error(errorMessage);
            }

        } catch (e) {
            console.error(`Gemini Call failed (Attempt ${attempt + 1}/${maxRetries}):`, e.message);
            if (attempt < maxRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
            } else {
                // Last attempt failed
                return { ok: false, error: e.message };
            }
        }
    }
}


const App = () => {
    // --- State Management ---
    const [geminiKey, setGeminiKey] = useState(''); // <-- User pastes the key here
    const [prompt, setPrompt] = useState('');
    const [chatHistory, setChatHistory] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [messageBox, setMessageBox] = useState({ message: null, type: 'success' });
    const [socialStatus, setSocialStatus] = useState('Disconnected');
    const [emailStatus, setEmailStatus] = useState('Sleeping (Awaiting Webhook)');
    const [donationAmount, setDonationAmount] = useState('');
    const [phoneNumber, setPhoneNumber] = useState('');

    const closeMessage = () => setMessageBox({ message: null, type: 'success' });
    const showMessage = (msg, type = 'success') => setMessageBox({ message: msg, type });

    // --- Core Chat Function (Live Gemini API Call) ---
    const sendPrompt = useCallback(async () => {
        if (!prompt.trim() || isLoading) return;
        if (!geminiKey) {
            showMessage("Please enter your Gemini API Key to enable live chat.", 'error');
            return;
        }

        appendMessage('user', prompt, chatHistory, setChatHistory);
        setPrompt('');
        setIsLoading(true);

        try {
            const response = await callGeminiApi(prompt, geminiKey);

            if (response.ok) {
                appendMessage('ai', response.text, chatHistory, setChatHistory);
            } else {
                appendMessage('ai', `${AIQUEEN_NAME} Error: ${response.error}. Check the console for details.`);
                showMessage(`Gemini Chat Failed: ${response.error}`, 'error');
            }
        } catch (e) {
            appendMessage('ai', `System Error: ${e.message}`);
            showMessage(`System Error: ${e.message}`, 'error');
        } finally {
            setIsLoading(false);
        }
    }, [prompt, isLoading, chatHistory, geminiKey]);

    // --- Tool Functions ---

    // 1. Stripe Donation Link Generation (Zero Custom Backend Code)
    const handleDonate = useCallback(async () => {
        if (!donationAmount || isNaN(donationAmount) || parseFloat(donationAmount) <= 0 || isLoading) return;

        setIsLoading(true);

        try {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const amountFormatted = parseFloat(donationAmount).toFixed(2);
            // This is the URL structure of the zero-code Stripe Payment Link
            const paymentLink = `https://buy.stripe.com/AIQUEEN_LINK_FOR_$${amountFormatted.replace('.', '')}`; 

            const successMessage = `Stripe Payment Link created (Simulation). Zero custom code cost! You can share this link immediately: ${paymentLink}`;
            showMessage(successMessage, 'success');
            appendMessage('ai', 
                `${AIQUEEN_NAME}: Generated zero-cost Stripe Payment Link for $${amountFormatted}. Embed this link in your static pages' donation buttons. Link: ${paymentLink}`
            );
        } finally {
            setIsLoading(false);
        }
    }, [donationAmount, isLoading]);

    // 2. Twilio Voice Call Integration (Requires Server)
    const handleCall = useCallback(() => {
        const warning = "Twilio voice calls require a secure backend server (like the Node.js server provided previously) to securely store keys and handle TwiML instructions. This client-side app cannot initiate a real call.";
        showMessage(warning, 'error');
        appendMessage('ai', `${AIQUEEN_NAME}: High-priority voice command failed. Reason: Twilio requires a secure server gateway to initiate calls and handle TwiML (voice instructions).`);
    }, []);


    // 3. Social Media Connection (Simulated)
    const connectSocialMedia = useCallback(() => {
        setIsLoading(true);
        setSocialStatus('Connecting...');
        setTimeout(() => {
            setIsLoading(false);
            const status = 'Connected to Facebook, X (formerly Twitter), and Instagram.';
            setSocialStatus(status);
            showMessage('Successfully connected social channels (Free API Access Simulation).', 'success');
            appendMessage('ai', `${AIQUEEN_NAME}: Social media connectivity established.`);
        }, 1500);
    }, []);

    // 4. Email Inbound Processor (Simulated)
    const processEmails = useCallback(() => {
        setIsLoading(true);
        setEmailStatus('Checking queue...');
        setTimeout(() => {
            setIsLoading(false);
            const emailsFound = Math.floor(Math.random() * 5);
            if (emailsFound > 0) {
                const status = `${emailsFound} emails (Processing)`;
                setEmailStatus(status);
                showMessage(`Found ${emailsFound} new emails for processing.`, 'success');
                appendMessage('ai', `${AIQUEEN_NAME}: Inbound email process triggered. ${emailsFound} messages are being handled by the AI.`);
            } else {
                const status = 'No new emails found. Queue is clear.';
                setEmailStatus(status);
                showMessage('Email queue is clear.', 'success');
                appendMessage('ai', `${AIQUEEN_NAME}: Email queue check complete.`);
            }
        }, 2000);
    }, []);

    // 5. Launch Bot (Simulated)
    const launchBot = useCallback(() => {
        setIsLoading(true);
        setTimeout(() => {
            setIsLoading(false);
            showMessage("Simulation: Launching campaign via free-tier Scheduler. Requires secure backend deployment.", 'success');
            appendMessage('ai', `${AIQUEEN_NAME}: Launching secure global campaign sequence...`);
        }, 1000);
    }, []);

    // Handle Enter keypress for prompt input
    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            sendPrompt();
        }
    };

    // Scroll to the latest message
    useEffect(() => {
        const chatEndRef = document.getElementById('chat-end-ref');
        chatEndRef?.scrollIntoView({ behavior: "smooth" });
    }, [chatHistory]);


    // --- UI Structure ---
    const chatContainerHeight = chatHistory.length === 0 ? 'h-full' : 'h-[calc(100%-8rem)] lg:h-[calc(100%-6rem)]';
    const isKeySet = !!geminiKey;

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col items-center p-4 sm:p-8">
            <div className="w-full max-w-7xl bg-white shadow-2xl rounded-2xl flex flex-col lg:flex-row overflow-hidden min-h-[90vh]">
                
                {/* Left Side: Campaign Management & Tools (Superior Indigo) */}
                <div className="w-full lg:w-1/3 bg-indigo-900 text-white p-6 space-y-6">
                    <h1 className="text-3xl font-extrabold border-b border-indigo-700 pb-3 mb-4 flex items-center">
                        <Crown className="mr-3 text-yellow-400 w-8 h-8" />
                        <span id="ai-queen-name">{AIQUEEN_NAME}</span>
                    </h1>
                    <p className="text-sm text-yellow-400">Client-Side Deployment (Dev/Test Only).</p>

                    {/* API Key Input (CRITICAL FOR FUNCTIONALITY) */}
                    <div className="p-4 bg-red-700 rounded-xl shadow-lg border-2 border-red-500 space-y-3">
                        <h2 className="text-xl font-semibold flex items-center">
                            <AlertTriangle className="mr-2 text-white w-5 h-5" /> Gemini API Key
                        </h2>
                        <p className="text-xs text-red-200 font-bold">
                            ⚠️ INSECURE: Do not use this method for production. This key is exposed.
                        </p>
                        <input
                            className="w-full p-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-400 placeholder-gray-500"
                            placeholder="Paste your GEMINI_API_KEY here"
                            type="password"
                            value={geminiKey}
                            onChange={(e) => setGeminiKey(e.target.value)}
                            disabled={isLoading}
                        />
                         <span className={`text-xs font-bold block text-center ${isKeySet ? 'text-green-300' : 'text-white'}`}>
                            {isKeySet ? 'Key Entered. Live Chat Enabled.' : 'Key Required for Chat.'}
                        </span>
                    </div>

                    <div className="space-y-4 pt-4">

                        {/* Donation (Stripe Integration - Zero Custom Code) */}
                        <div className="p-4 bg-indigo-800 rounded-xl shadow-lg border border-indigo-700">
                            <h2 className="text-xl font-semibold mb-3 flex items-center">
                                <DollarSign className="mr-2 text-yellow-400 w-5 h-5" /> Zero-Cost Donation Link
                            </h2>
                            <p className="text-xs mb-2 text-yellow-300">Generates shareable Stripe links for static pages.</p>
                            <input
                                className="w-full p-3 mb-2 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                                placeholder="Donation Target USD (e.g., 50.00)"
                                type="number"
                                value={donationAmount}
                                onChange={(e) => setDonationAmount(e.target.value)}
                                disabled={isLoading}
                            />
                            <button
                                className="w-full bg-yellow-400 text-indigo-900 font-bold py-3 rounded-lg hover:bg-yellow-300 transition duration-150 shadow-lg disabled:bg-gray-500"
                                onClick={handleDonate}
                                disabled={isLoading || !donationAmount || parseFloat(donationAmount) <= 0}
                            >
                                Generate Stripe Link
                            </button>
                        </div>

                        {/* Voice Call (Twilio Integration - Requires Server) */}
                        <div className="p-4 bg-indigo-800 rounded-xl shadow-lg border border-indigo-700">
                            <h2 className="text-xl font-semibold mb-3 flex items-center">
                                <Phone className="mr-2 text-red-400 w-5 h-5" /> Call AIQUEEN (Twilio)
                            </h2>
                            <p className="text-xs mb-2 text-indigo-400">Initiates a real-time voice call (requires secure backend server).</p>
                            <input
                                className="w-full p-3 mb-2 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-400"
                                placeholder="+15551234567"
                                type="tel"
                                value={phoneNumber}
                                onChange={(e) => setPhoneNumber(e.target.value)}
                                disabled={isLoading}
                            />
                            <button
                                className="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-lg disabled:bg-gray-500"
                                onClick={handleCall}
                                disabled={isLoading || !phoneNumber}
                            >
                                Call AIQUEEN Now (Test)
                            </button>
                        </div>
                        
                        {/* Email Inbound Processor (Simulated) */}
                        <div className="p-4 bg-indigo-800 rounded-xl shadow-lg border border-indigo-700">
                            <h2 className="text-xl font-semibold mb-3 flex items-center">
                                <Mail className="mr-2 text-red-400 w-5 h-5" /> Email Processor (Simulated)
                            </h2>
                            <p className="text-sm text-indigo-400 mb-3">
                                Handles AI routing for emails received via your connected Gmail.
                            </p>
                            <button
                                className="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition duration-150 shadow-lg disabled:bg-gray-500"
                                onClick={processEmails}
                                disabled={isLoading}
                            >
                                Check Email Queue
                            </button>
                            <p className="mt-2 text-xs text-red-300 text-center">{emailStatus}</p>
                        </div>

                        {/* Social Media Integration Panel (Simulated) */}
                        <div className="p-4 bg-indigo-800 rounded-xl shadow-lg border border-indigo-700">
                            <h2 className="text-xl font-semibold mb-3 flex items-center">
                                <Share2 className="mr-2 text-blue-400 w-5 h-5" /> Global Social Connect (Simulated)
                            </h2>
                            <p className="text-sm text-indigo-400 mb-3">
                                Connect platforms using their Developer Free Tiers.
                            </p>
                            <button
                                className="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition duration-150 shadow-lg disabled:bg-gray-500"
                                onClick={connectSocialMedia}
                                disabled={isLoading}
                            >
                                Connect Social Channels
                            </button>
                            <p className="mt-2 text-xs text-blue-300 text-center">{socialStatus}</p>
                        </div>
                        
                        {/* Launch Bot (Simulated) */}
                        <div className="p-4 bg-indigo-800 rounded-xl shadow-lg border border-indigo-700">
                            <h2 className="text-xl font-semibold mb-3 flex items-center">
                                <Zap className="mr-2 text-pink-400 w-5 h-5" /> Launch AI Outreach Bot (Simulated)
                            </h2>
                            <p className="text-sm text-indigo-400 mb-3">
                                Sends campaigns via a simple scheduler service.
                            </p>
                            <button
                                className="w-full bg-pink-500 text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition duration-150 shadow-lg disabled:bg-gray-500"
                                onClick={launchBot}
                                disabled={isLoading}
                            >
                                Launch Global Campaign Bot
                            </button>
                        </div>

                    </div>
                </div>

                {/* Right Side: Chat Interface */}
                <div className="w-full lg:w-2/3 flex flex-col relative p-4 sm:p-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">AI Multitasking Agent</h2>
                    
                    {/* Chat History Container */}
                    <div className={`overflow-y-auto space-y-4 p-2 bg-gray-50 rounded-lg border flex-grow ${chatContainerHeight}`}>
                        {chatHistory.length === 0 && (
                            <div className="text-center text-gray-500 pt-16">
                                <p className="mb-2">Paste your Gemini Key on the left to activate the live AI chat.</p>
                                <p className="italic text-sm">Once activated, try asking the AI to "draft a promotional pitch for the donation page."</p>
                            </div>
                        )}
                        
                        {chatHistory.map((msg, index) => (
                            <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-xs sm:max-w-md p-3 rounded-xl shadow-md ${
                                    msg.role === 'user'
                                        ? 'bg-indigo-600 text-white rounded-br-none'
                                        : 'bg-white text-gray-800 border border-gray-100 rounded-tl-none'
                                }`}>
                                    <span className="font-semibold text-xs opacity-75 mr-2">
                                        {msg.role === 'user' ? 'You' : AIQUEEN_NAME}
                                    </span>
                                    <p className="mt-1 whitespace-pre-wrap">{msg.text}</p>
                                </div>
                            </div>
                        ))}
                        <div id="chat-end-ref"></div>
                    </div>
                    
                    {/* Input Area */}
                    <div 
                        className="mt-6 flex items-center w-full max-w-3xl mx-auto p-3 bg-white 
                               rounded-2xl shadow-xl shadow-indigo-300/50 border border-gray-200 
                               transition-all duration-300 hover:shadow-indigo-400/60"
                    >
                        <input
                            className="flex-grow p-3 border-none rounded-l-xl focus:outline-none focus:ring-0 text-gray-700 text-lg"
                            placeholder="Message AIQUEEN..."
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            onKeyDown={handleKeyDown}
                            disabled={isLoading}
                        />
                        <button
                            className="px-5 py-3 ml-2 bg-indigo-500 text-white font-semibold rounded-xl 
                                   hover:bg-indigo-600 transition duration-150 flex items-center justify-center 
                                   disabled:bg-gray-400 shadow-md hover:shadow-lg"
                            onClick={sendPrompt}
                            disabled={isLoading || !prompt.trim() || !geminiKey}
                            title="Send Command"
                        >
                            {isLoading ? (
                                <Loader className="animate-spin h-6 w-6" />
                            ) : (
                                <Send className="w-6 h-6" />
                            )}
                        </button>
                    </div>
                </div>
            </div>
            
            <MessageBox {...messageBox} onClose={closeMessage} />
        </div>
    );
};

export default App;
